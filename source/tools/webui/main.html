<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="SigmaDrone Flight Deck">
  <meta name="author" content="SigmaDrone Developers">
  <link rel="icon" href="./images/logo.ico">

  <title>SigmaDrone Flight Deck</title>

  <!-- Bootstrap core CSS -->
  <link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="./css/main.css" rel="stylesheet">

  <link rel="stylesheet" href="./font-awesome/css/font-awesome.min.css">

</head>

<body>
  <div class="container">
    <div class="header">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#home" onClick="onSigmaDroneLogoClick()" data-toggle="tab">
              <img alt="SigmaDrone" src="./images/logo.svg" height="45">
            </a>
          </div>
          <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav nav-pills">
              <li class="active"><a href="#home" data-toggle="tab" id="home-button">Home</a></li>
              <li><a href="#control" data-toggle="tab"><span class="glyphicon glyphicon-wrench"></span> Configure</a></li>
              <li><a href="#drone-data" data-toggle="tab"><i class="fa fa-bar-chart"></i> Analyze</a></li>
            </ul>
          </div> <!-- navbar-collapse-->
        </div><!-- container-fluid -->
      </nav>
    </div><!-- header -->

    <hr class="featurette-divider">

    <div class="tab-content main">

      <div id="home" class="tab-pane fade in active">
        <div class="warning-message" id="warning-message-id">
          <div class="row">
            <div class="col-xs-12"> <span class="warning-message">Connecting to drone... </span> </div>
          </div>
          <hr class="featurette-divider">
        </div>
        <div class="row" id="battery-motor-status-id">
          <div class="col-xs-5 col-md-5">
            <span>Motors </span>
            <i class="fa fa-toggle-off fa-lg fa-rotate-270" id="motors-armed-icon"></i>
          </div>
          <div class="col-xs-7 col-md-7 text-right">
            <span id="battery-percent">N/A</span>%
            <i class="fa fa-battery-0 fa-lg" id="battery-icon"></i>
          </div>
        </div>
        <hr class="featurette-divider">
        <div class="row">
          <div class="col-xs-4">Attitude</div>
          <div class="col-xs-6"></div>
        </div>
        <div class="row">
          <div class="col-xs-12 col-data attitude"><span id="attQ">w:1.000 x:0.000 y:0.000 z:0.000</span></div>
        </div>
        <div class="row">
          <div class="col-xs-12 col-data col-md-12"><span id="euler-angles-id">x:0.000 y:0.000 z:0.000</span></div>
        </div>
        <div class="row row-padded">
          <div class="col-xs-12">
            <div class="row"> <div class="col-xs-11">Relative Altitude</div> </div>
            <div class="row">
              <div class="col-xs-6 col-md-3 col-data"><span id="altitude">100</span> m</div>
              <div class="col-xs-6 col-md-3 col-data"><span id="flight-posture-id">MANUAL</span></div>
            </div>
          </div>
        </div>
        <div class="row row-padded">
          <div class="col-xs-12">
            <div class="row"> <div class="col-xs-11">Speed</div> </div>
            <div class="row"> <div class="col-xs-10 col-data"><span id="gps-speed">0</span> km/h</div> </div>
          </div>
        </div>
        <div id="alarm-gr" class="alarm-gr">
          <div class="row row-padded alarm">
            <div class="col-xs-12"> <span id="alarm"></span> </div>
          </div>
          <div class="row" id="alarm-data-row">
            <div class="col-xs-12 col-md-6 col-data"> <span id="alarm-data">Channel No</span></div>
          </div>
          <div class="row">
            <div class="col-xs-12 col-md-6 col-data"> Time of alarm: <span id="alarm-time">6384</span> secs</div>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded sensors">
          <a href="#sensors-id" id="sensors-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Sensors
          </a>
          <div id="sensors-id" class="col-xs-12 col-data collapse">
            <div class="row row-padded"> <div class="col-xs-11">Accelerometer</div> </div>
            <div class="row">
              <div class="col-xs-11 col-data"><span id="accel">x:0.000 y:0.000 z:1.000</span></div>
            </div>
            <div class="row row-padded"> <div class="col-xs-11">Gyroscope, deg/s</div> </div>
            <div class="row">
              <div class="col-xs-11 col-data"><span id="gyro">x:0.000 y:0.000 z:0.000</span></div>
            </div>
            <div class="row row-padded"> <div class="col-xs-11">Gyroscope Unbiased, deg/s</div> </div>
            <div class="row">
              <div class="col-xs-11 col-data"><span id="gyro-raw-id">x:0.000 y:0.000 z:0.000</span></div>
            </div>
            <div class="row row-padded"> <div class="col-xs-11">Gyroscope Drift, deg/s</div> </div>
            <div class="row">
              <div class="col-xs-11 col-data"><span id="gyro-drift-id">x:0.000 y:0.000 z:0.000</span></div>
            </div>
            <div class="row row-padded"> <div class="col-xs-11">Magnetometer</div> </div>
            <div class="row">
              <div class="col-xs-11 col-data"><span id="mag">x:0.000 y:0.000 z:0.000</span></div>
            </div>
            <div class="row row-padded"> <div class="col-xs-11">Pressure</div> </div>
            <div class="row">
              <div class="col-xs-11 col-data"><span id="hpa">0</span> hPA </div>
            </div>
            <div class="row row-padded"> <div class="col-xs-11">Temperature</div> </div>
            <div class="row">
              <div class="col-xs-11 col-data"><span id="temperature">0</span> C </div>
            </div>
            <div class="row row-padded"> <div class="col-xs-11">dT</div> </div>
            <div class="row">
              <div class="col-xs-11 col-data"><span id="dt">0</span> mS</div>
            </div>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#motors-id" id="motors-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Motors
          </a>
          <div id = "motors-id" class="collapse">
            <div class="row motor-group">
              <div class="motor" id="motor2"></div> <div class="motor" id="motor1"></div>
            </div>
            <div class="row motor-group">
              <div class="motor" id="motor3"></div> <div class="motor" id="motor4"></div>
            </div>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#gps-id" id="gps-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>GPS
          </a>
          <div id = "gps-id" class="col-xs-12 collapse">
            <div class="row">
              <div class="col-md-2 col-xs-4 col-data">Latitude:</div>
              <div class="col-md-4 col-xs-6 col"><span id="gps-lat">45.00</span> deg</div>
            </div>
            <div class="row">
              <div class="col-md-2 col-xs-4 col-data">Longitude:</div>
              <div class="col-md-4 col-xs-6 col"><span id="gps-long">-112.00</span> deg</div>
            </div>
            <div class="row">
              <div class="col-md-2 col-xs-4 col-data">SAT Count:</div>
              <div class="col-md-4 col-xs-6 col"><span id="gps-satellites">3</span></div>
            </div>
            <div class="row">
              <div class="col-md-2 col-xs-4 col-data">Course:</div>
              <div class="col-md-4 col-xs-6 col"><span id="gps-course">360</span> deg</div>
            </div>
            <div class="row">
              <div class="col-md-2 col-xs-4 col-data">Altitude:</div>
              <div class="col-md-4 col-xs-6 col"><span id="gps-altitude">0</span> m</div>
            </div>
            <div class="row">
              <div class="col-md-2 col-xs-4 col-data">Position Error:</div>
              <div class="col-md-4 col-xs-6 col"><span id="gps-position-error">0</span> m</div>
            </div>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#rc-control-id" id="rc-control-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>RC Control
          </a>
          <div id="rc-control-id" class="col-xs-12 col-data collapse">
            <div class="row">
              <div class="col-xs-3 col-md-1 col-data"><span>Roll:</span></div>
              <div class="col-xs-8 col-data"><span id="roll-id">Roll me</span></div>
            </div>
            <div class="row">
              <div class="col-xs-3 col-md-1 col-data"><span>Pitch:</span></div>
              <div class="col-xs-8 col-data"><span id="pitch-id">Pitch me</span></div>
            </div>
            <div class="row">
              <div class="col-xs-3 col-md-1 col-data"><span>Yaw:</span></div>
              <div class="col-xs-8 col-data"><span id="yaw-id">Yawn</span></div>
            </div>
            <div class="row">
              <div class="col-xs-3 col-md-1 col-data"><span>Throttle:</span></div>
              <div class="col-xs-8 col-data"><span id="throttle-id">Yawn</span></div>
            </div>
            <div class="row">
              <div id="dygraph-id"> </div>
            </div>
          </div>
        </div>

        <hr class="featurette-divider">

      </div> <!--div id="home" class="container tab-pane fade in active"-->

      <div id="control" class="tab-pane fade">
        <div class="row row-padded">
          <a href="#pidxy-id" id="pidxy-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>PID Controller XY
          </a>
          <div id = "pidxy-id" class="col-xs-12 collapse">
            <form class="form-horizontal" role="form" id="pidxy-form" onsubmit="return onPidXYSubmit();">
              <div class="form-group"><!-- aria-invalid="true"-->
                <div class="col-xs-4 col-md-2">
                  <label for="kp-xy">Kp</label>
                  <input id="kp-xy" name="kp-xy" class="form-control input-sm" type="number" min="0.0" max="1.0" step="0.001" required="true" oninput="onPidXYUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="ki-xy">Ki</label>
                  <input id="ki-xy" name="ki-xy" class="form-control input-sm" type="number" min="0.0" max="1.0" step="0.001" required="true" oninput="onPidXYUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="kd-xy">Kd</label>
                  <input id="kd-xy" name="kd-xy" class="form-control input-sm" type="number" min="0.0" max="1.0" step="0.001" required="true" oninput="onPidXYUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="leakrate-xy">Leak Rate</label>
                  <input id="leakrate-xy" name="leakrate-xy" class="form-control input-sm" type="number" min="0.0" max="1.0" step="0.0001" required="true" oninput="onPidXYUserInput()">
                </div>
              </div>
              <div class="form-group">
                <div class="col-xs-3 col-md-1">
                  <button type="submit" class="btn btn-default" id="pidxy-apply-btn">Apply</button>
                </div>
                <div class="col-xs-3 col-md-1">
                  <button type="button" class="btn btn-default" id="pidxy-cancel-btn" onClick="onPidXYCancel();">Cancel</button>
                </div>
                <div class="col-xs-9 col-md-11">
                  <span id="pidxy-help" class="help-block"></span>
                </div>
              </div>
            </form>
          </div> <!--div id = "pidxy-id" class="col-xs-12 collapse"-->
        </div> <!--div class="row row-padded"-->

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#pidz-id" id="pidz-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>PID Controller Z
          </a>
          <div id = "pidz-id" class="col-xs-12 collapse">
            <form class="form-horizontal" role="form" id="pidz-form" onsubmit="return onPidZSubmit();">
              <div class="form-group">
                <div class="col-xs-4 col-md-2">
                  <label for="kp-z">Kp</label>
                  <input id="kp-z" name="kp-z" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidZUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="ki-z">Ki</label>
                  <input id="ki-z" name="ki-z" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidZUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="kd-z">Kd</label>
                  <input id="kd-z" name="kd-z" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidZUserInput()">
                </div>
              </div>
              <div class="form-group">
                <div class="col-xs-3 col-md-1">
                  <button type="submit" class="btn btn-default disabled" id="pidz-apply-btn">Apply</button>
                </div>
                <div class="col-xs-3 col-md-1">
                  <button type="button" class="btn btn-default" id="pidz-cancel-btn" onClick="onPidZCancel();">Cancel</button>
                </div>
                <div class="col-xs-9 col-md-11">
                  <span id="pidz-help" class="help-block"></span>
                </div>
              </div>
            </form>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#pid-altitude-id" id="pid-altitude-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Altitude Controller
          </a>
          <div id = "pid-altitude-id" class="col-xs-12 collapse">
            <form class="form-horizontal" role="form" id="pid-altitude-form" onsubmit="return onPidAltitudeSubmit();">
              <div class="form-group">
                <div class="col-xs-4 col-md-2">
                  <label for="kp-altitude">Kp</label>
                  <input id="kp-altitude" name="kp-altitude" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidAltitudeUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="ki-altitude">Ki</label>
                  <input id="ki-altitude" name="ki-altitude" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidAltitudeUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="kd-altitude">Kd</label>
                  <input id="kd-altitude" name="kd-altitude" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidAltitudeUserInput()">
                </div>
              </div>
              <div class="form-group">
                <div class="col-xs-4 col-md-2">
                  <label for="alt-correction-period">Correction Period, Sec</label>
                  <input id="alt-correction-period" name="alt-correction-period" class="form-control input-sm" type="number" min="0.100" max="3600" step="0.1" required="true" oninput="onPidAltitudeUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="ki-altitude-leak">Ki Leak Rate</label>
                  <input id="ki-altitude-leak" name="ki-altitude-leak" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidAltitudeUserInput()">
                </div>
              </div>
              <div class="form-group">
                <div class="col-xs-3 col-md-1">
                  <button type="submit" class="btn btn-default disabled" id="pid-altitude-apply-btn">Apply</button>
                </div>
                <div class="col-xs-3 col-md-1">
                  <button type="button" class="btn btn-default" id="pid-altitude-cancel-btn" onClick="onPidAltitudeCancel();">Cancel</button>
                </div>
                <div class="col-xs-9 col-md-11">
                  <span id="pid-altitude-help" class="help-block"></span>
                </div>
              </div>
            </form>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#pid-gyro-id" id="pid-gyro-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>PID Controller Gyro Drift
          </a>
          <div id = "pid-gyro-id" class="col-xs-12 collapse">
            <form class="form-horizontal" role="form" id="pid-gyro-form" onsubmit="return onPidGyroSubmit();">
              <div class="form-group">
                <div class="col-xs-4 col-md-2">
                  <label for="kp-gyro">Kp</label>
                  <input id="kp-gyro" name="kp-gyro" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidGyroUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="ki-gyro">Ki</label>
                  <input id="ki-gyro" name="ki-gyro" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidGyroUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="kd-gyro">Kd</label>
                  <input id="kd-gyro" name="kd-gyro" class="form-control input-sm" type="number" min="0.0" max="1.2" step="0.001" required="true" oninput="onPidGyroUserInput()">
                </div>
              </div>
              <div class="form-group">
                <div class="col-xs-3 col-md-1">
                  <button type="submit" class="btn btn-default disabled" id="pid-gyro-apply-btn">Apply</button>
                </div>
                <div class="col-xs-3 col-md-1">
                  <button type="button" class="btn btn-default" id="pid-gyro-cancel-btn" onClick="onPidGyroCancel();">Cancel</button>
                </div>
                <div class="col-xs-9 col-md-11">
                  <span id="pid-gyro-help" class="help-block"></span>
                </div>
              </div>
            </form>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#flight-ctl-id" id="flight-ctl-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Flight Control
          </a>
          <div id = "flight-ctl-id" class="col-xs-12 collapse">
            <form class="form-horizontal" role="form" id="flight-ctl-form" onsubmit="return onFlightCtlSubmit();">
              <div class="form-group" id="set-flight-mode-gr">
                <div class="col-xs-4 col-md-2">
                  <label for="set-flight-mode-gr">Set Flight Mode</label>
                </div>
                <div class="col-xs-4 col-md-3">
                  <select name="flight-mode" id="flight-mode-id" onclick="onFlightCtlUserInput()">
                    <option value="flight-mode-auto-level">Auto Level</option>
                    <option value="flight-mode-altitude">Altitude Hold</option>
                    <option value="flight-mode-position">Position Hold</option>
                  </select>
                </div>
              </div>
              <div class="form-group" id="track-magnotemeter-gr">
                <div class="col-xs-8 col-md-4">
                  <label for="track-magnetometer-gr">Track Magnetometer</label>
                  <span style="width:5px;display:inline-block"></span>
                  <input id="track-magnetometer" name="track-magnetometer" type="checkbox" onclick="onFlightCtlUserInput()">
                </div>
              </div>
              <label for="torq-corr-gr">Torque Correction</label>
              <div class="form-group" id="torq-corr-gr">
                <div class="col-xs-4 col-md-2">
                  <label for="torq-bias-roll">Roll</label>
                  <input id="torq-bias-roll" name="torq-bias-roll" class="form-control input-sm" type="number" min="-0.1" max="0.1" step="0.001" required="true" oninput="onFlightCtlUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="torq-bias-pitch">Pitch</label>
                  <input id="torq-bias-pitch" name="torq-bias-pitch" class="form-control input-sm" type="number" min="-0.1" max="0.1" step="0.001" required="true" oninput="onFlightCtlUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="torq-bias-yaw">Yaw</label>
                  <input id="torq-bias-yaw" name="torq-bias-yaw" class="form-control input-sm" type="number" min="-0.1" max="0.1" step="0.001" required="true" oninput="onFlightCtlUserInput()">
                </div>
              </div>
              <div class="form-group" id="external-gyro-gr">
                <div class="col-xs-8 col-md-4">
                  <label for="external-gyro-gr">Enable External Gyro</label>
                  <span style="width:5px;display:inline-block"></span>
                  <input id="external-gyro" name="external-gyro" type="checkbox" onclick="onFlightCtlUserInput()">
                </div>
              </div>
              <label for="yaw-throttle-factor-gr">Yaw Throttle Factor</label>
              <div class="form-group" id="yaw-throttle-factor-gr">
                <div class="col-xs-4 col-md-2">
                  <input id="yaw-throttle-factor" name="yaw-throttle-factor" class="form-control input-sm" type="number" min="0.0" max="0.9" step="0.001" required="true" oninput="onFlightCtlUserInput()">
                </div>
              </div>
              <div class="form-group">
                <div class="col-xs-3 col-md-1">
                  <button type="submit" class="btn btn-default disabled" id="flight-ctl-apply-btn">Apply</button>
                </div>
                <div class="col-xs-3 col-md-1">
                  <button type="button" class="btn btn-default" id="flight-ctl-cancel-btn" onClick="onFlightCtlCancel();">Cancel</button>
                </div>
                <div class="col-xs-9 col-md-11">
                  <span id="flight-ctl-help" class="help-block"></span>
                </div>
              </div>
            </form>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#sensors-config-id" id="sensors-config-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Configure Sensors
          </a>
          <div id = "sensors-config-id" class="col-xs-12 collapse">
            <form class="form-horizontal" role="form" id="sensors-config-form" onsubmit="return onSensorsConfigSubmit();">
              <label for="acc-bias-gr">Accelerometer Bias</label>
              <div class="form-group" id="acc-bias-gr">
                <div class="col-xs-4 col-md-2">
                  <label for="acc-bias-x">X</label>
                  <input id="acc-bias-x" name="acc-bias-x" class="form-control input-sm" type="number" min="-0.5" max="0.5" step="0.001" required="true" oninput="onSensorsConfigUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="acc-bias-y">Y</label>
                  <input id="acc-bias-y" name="acc-bias-y" class="form-control input-sm" type="number" min="-0.5" max="0.5" step="0.001" required="true" oninput="onSensorsConfigUserInput()">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="acc-bias-z">Z</label>
                  <input id="acc-bias-z" name="acc-bias-z" class="form-control input-sm" type="number" min="-0.5" max="0.5" step="0.001" required="true" oninput="onSensorsConfigUserInput()">
                </div>
              </div>

              <label for="acc-corr-per-gr">Accelerometer Correction Speed (Deg/Sec)</label>
              <div class="form-group" id="acc-corr-per-gr">
                <div class="col-xs-4 col-md-2">
                  <input id="acc-corr-period" name="acc-corr-period" class="form-control input-sm" type="number" min="0.0" max="10.0" step="0.01" required="true" oninput="onSensorsConfigUserInput()">
                </div>
              </div>

              <label for="gyro-factor-gr">Gyro Correction Factor</label>
              <div class="form-group" id="gyro-factor-gr">
                <div class="col-xs-4 col-md-2">
                  <input id="gyro-factor" name="gyro-factor" class="form-control input-sm" type="number" min="0.0" max="2.0" step="0.01" required="true" oninput="onSensorsConfigUserInput()">
                </div>
              </div>

              <div class="form-group">
                <div class="col-xs-3 col-md-1">
                  <button type="submit" class="btn btn-default disabled" id="sensors-apply-btn">Apply</button>
                </div>
                <div class="col-xs-3 col-md-1">
                  <button type="button" class="btn btn-default" id="sensors-cancel-btn" onClick="onSensorsConfigCancel();">Cancel</button>
                </div>
                <div class="col-xs-9 col-md-11">
                  <span id="sensors-config-help" class="help-block"></span>
                </div>
              </div>
            </form>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#sensors-calibrate-id" id="sensors-calibrate-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Calibrate Sensors
          </a>
          <div id="sensors-calibrate-id" class="col-xs-12 col-data collapse">
            <div class="row">
              <div class="col-xs-12 col-md-12">
                <a id="mag-calibrate-btn" class="btn btn-link" onClick="onToggleMagCalibrateButton();">
                  <span id="mag-calibrate-btn-message">Calibrate Magnetometer</span> <i class="fa fa-toggle-off fa-lg" id="mag-calibrate-btn-icon"></i>
                </a>
              </div>
              <div class="col-xs-12 col-md-12 col-data-sensors">
                <span id="mag-calibrate-message-id"></span>
              </div>
            </div>
            <div id="mag-calib-data-id">
              <div class="row row-padded">
                <div class="col-xs-5 col-md-2 col-data-sensors">
                  <span>Mag Bias</span>
                </div>
                <div class="col-xs-7 col-md-10">
                  <span id="mag-bias-id">X:0.0 Y:0.0 Z:0.0</span>
                </div>
              </div>
              <div class="row row-padded">
                <div class="col-xs-5 col-md-2 col-data-sensors">
                  <span>Mag Scale</span>
                </div>
                <div class="col-xs-7 col-md-10">
                  <span id="mag-scale-id">X:1.0 Y:1.0 Z:1.0</span>
                </div>
              </div>
            </div>
          </div>
        </div>


        <hr class="featurette-divider">

        <div class="row-padded">
          <form class="form-horizontal" role="form" id="restore-defaults-form" onsubmit="return onRestoreDefaultConfig();">
            <div class="form-group">
              <div class="col-xs-8 col-md-4">
                <button type="submit" class="btn btn-default btn-block disabled" id="restore-apply-btn">Restore Defaults</button>
              </div>
              <div class="col-xs-3 col-md-1 hidden-element">
                  <button type="button" class="btn btn-default" id="restore-cancel-btn">Cancel</button>
              </div>
              <div class="col-xs-9 col-md-11">
                <span id="restore-defaults-help" class="help-block"></span>
              </div>
            </div>
          </form>
        </div>

        <div class="row-padded">
          <form class="form-horizontal" role="form" id="save2flash-form" onsubmit="return onSaveConfig2Flash();">
            <div class="form-group">
              <div class="col-xs-8 col-md-4">
                <button type="submit" class="btn btn-primary btn-block disabled" id="save2flash-apply-btn">Save to Flash</button>
              </div>
              <div class="col-xs-3 col-md-1 hidden-element">
                  <button type="button" class="btn btn-default" id="save2flash-cancel-btn">Cancel</button>
              </div>
              <div class="col-xs-9 col-md-11">
                <span id="save2flash-help" class="help-block"></span>
              </div>
            </div>
          </form>
        </div>

        <hr class="featurette-divider">

      </div> <!--div id="control" class="container tab-pane fade"-->

      <div id="drone-data" class="tab-pane fade">
        <div class="container-fluid">
          <div class="row row-padded">
            <div class="col-xs-6 col-md-2">
              <a id="collect-data-btn" class="btn btn-link" onClick="onToggleCollectDataButton();">
                <span>Collect Data</span> <i class="fa fa-toggle-off fa-lg" id="collect-data-btn-icon"></i>
              </a>
            </div>
            <div class="col-xs-6 col-md-2">
              <a id="sync-graph-btn" class="btn btn-link" onClick="onToggleSyncGraphButton();">
                <span>Sync Timelines</span> <i class="fa fa-toggle-off fa-lg" id="sync-graph-btn-icon"></i>
              </a>
            </div>
          </div> <!--div class="row row-padded"-->
          <hr class="featurette-divider">
          <h4 class="graph-title">IMU Sensors</h4>
          <a href="#sensor-chart-ydata-select-id" id="sensor-chart-data-select-bt" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Filter Data
          </a>
          <div id = "sensor-chart-ydata-select-id" class="col-xs-12 collapse">
            <div class="row">
              <div class="col-xs-3 col-md-2 col-data">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartAccXData(this)">Acc X</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartAccYData(this)">Acc Y</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartAccZData(this)">Acc Z</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-3 col-md-2 col-data">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartMagXData(this)">Mag X</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartMagYData(this)">Mag Y</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartMagZData(this)">Mag Z</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-3 col-md-2 col-data">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartGyroXData(this)">Gyro X</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartGyroYData(this)">Gyro Y</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartGyroZData(this)">Gyro Z</label>
                </div>
              </div>
            </div>
            <div class="row row-padded"></div>
          </div>
          <div id="sensor-chart-id"></div>

          <div class="row row-padded"></div>
          <hr class="featurette-divider">

          <h4 class="graph-title">Attitude and Torque</h4>
          <a href="#error-chart-ydata-select-id" id="error-chart-data-select-bt" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Filter Data
          </a>
          <div id = "error-chart-ydata-select-id" class="col-xs-12 collapse">
            <div class="row">
              <div class="col-xs-3 col-md-2 col-data">
                <div class="checkbox">
                    <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartAttitudeRollData(this)">Roll</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartAttitudePitchData(this)">Pitch</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartAttitudeYawData(this)">Roll</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-3 col-md-2 col-data">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartTorqXData(this)">Torq X</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartTorqYData(this)">Torq Y</label>
                </div>
              </div>
              <div class="col-xs-3 col-md-2">
                <div class="checkbox">
                  <label> <input type="checkbox" value="" checked="true" onchange="onToggleChartTorqZData(this)">Torq Z</label>
                </div>
              </div>
            </div>
            <div class="row row-padded"></div>
          </div>

          <div id="error-chart-id"></div>

          <div class="row row-padded"></div>
          <hr class="featurette-divider">

          <h4 class="graph-title">Altitude</h4>
          <a href="#altitude-chart-ydata-select-id" id="altitude-chart-data-select-bt" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Filter Data
          </a>
          <div id="altitude-chart-ydata-select-id" class="col-xs-12 collapse">
            <div class="row">
              <div class="col-xs-6 col-md-3 col-data">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" value="" checked="true" onchange="onToggleChartAltitude(this)">Estimated Altitude, m</label>
                </div>
              </div>
              <div class="col-xs-6 col-md-3 col-data">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" value="" checked="true" onchange="onToggleChartVerticalSpeed(this)">Vertical Speed, m/s</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-6 col-md-3 col-data">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" value="" checked="true" onchange="onToggleChartAltitudeRaw(this)">Altitude Raw, m</label>
                </div>
              </div>
              <div class="col-xs-6 col-md-3 col-data">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" value="" checked="true" onchange="onToggleChartTargetVerticalSpeed(this)">Target Vertical Speed, m/s</label>
                </div>
              </div>
            </div>
            <div class="row">
                <div class="col-xs-6 col-md-3 col-data">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" value="" checked="true" onchange="onToggleChartTargetAltitude(this)">Target Altitude, m</label>
                    </div>
                  </div>
            </div>
            <div class="row row-padded"></div>
          </div>

          <div id="altitude-chart-id"></div>

          <div class="row row-padded"></div>
          <hr class="featurette-divider">

          <h4 class="graph-title">RC Values</h4>
          <div id="rcvalues-chart-id"></div>
          <div class="row row-padded"></div>
          <hr class="featurette-divider">

      </div> <!-- div id = "drone-data" -->

      <hr class="featurette-divider">

    </div> <!--div class="tab-content"-->

    <footer class="footer">
      <p>
        &copy; Sigmadrone 2017
      </p>
    </footer>

  </div><!-- container -->

   <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="./jquery/jquery-2.1.1.min.js"></script>
  <script src="./bootstrap/js/bootstrap.min.js"></script>
  <script src="./justgauge/raphael-2.1.4.min.js"></script>
  <script src="./justgauge/justgage-1.1.0.min.js"></script>
  <script src="./js/formmvc.js"></script>
  <script src="./js/togglebutton.js"></script>
  <script src="./js/vis.min.js"></script>
  <script src="./js/chart2d.js"></script>
  <script src="./js/rpcclient.js"></script>
  <script src="./js/chartmodel.js"></script>
  <script src="./js/qtmath.js"></script>
  <link href="./js/vis.min.css" rel="stylesheet" type="text/css" />

  <script>
  var id = 0;
  var m1, m2, m3, m4;
  var pidxyView = new PidXYFormView("#pidxy-form",
    "#pidxy-apply-btn",
    "#pidxy-cancel-btn",
    "#pidxy-help");
  var pidzView = new PidZFormView("#pidz-form",
    "#pidz-apply-btn",
    "#pidz-cancel-btn",
    "#pidz-help");
  var pidAltitudeView = new PidAltitudeFormView(
      "#pid-altitude-form",
      "#pid-altitude-apply-btn",
      "#pid-altitude-cancel-btn",
      "#pid-altitude-help");
  var pidGyroView = new PidGyroFormView("#pid-gyro-form",
      "#pid-gyro-apply-btn",
      "#pid-gyro-cancel-btn",
      "#pid-gyro-help");
  var flightCtlView = new FlightCtlFormView("#flight-ctl-form",
    "#flight-ctl-apply-btn",
    "#flight-ctl-cancel-btn",
    "#flight-ctl-help");
  var sensorCfgView = new SensorsCfgFormView("#sensors-config-form",
    "#sensors-apply-btn",
    "#sensors-cancel-btn",
    "#sensors-config-help");
  var restoreDefaultsView = new FormView("#restore-defaults-form",
    "#restore-apply-btn",
    "#restore-cancel-btn",
    "#restore-defaults-help",
    "Restoring default configuration...",
    "Failed to restore default configuration!");
  var save2FlashView = new FormView("#save2flash-form",
    "#save2flash-apply-btn",
    "#save2flash-cancel-btn",
    "#save2flash-help",
    "Saving boot-configuration to flash...",
    "Failed to save boot-configuration to flash!");
  var collectDataButton = new ToggleButton(
    "#collect-data-btn",
    "#collect-data-btn-icon",
    false);
  var syncGraphButton = new ToggleButton(
      "#sync-graph-btn",
      "#sync-graph-btn-icon",
      false);
  var magCalibrateButton = new ToggleButton(
        "#mag-calibrate-btn",
        "#mag-calibrate-btn-icon",
        false);
        var droneState = null;
  var droneRpcUrl;
  var rpcClient = new RpcClient();
  var sensorChart = null;
  var attitudeChart = null;
  var altitudeChart = null;
  var altitudeChartModel = null;
  var rcValuesChart = null;

/*
  g = new Dygraph(
    document.getElementById("dygraph-id"),
    // For possible data formats, see http://dygraphs.com/data.html
    // The x-values could also be dates, e.g. "2012/03/15"
    "X,Y,Z\n" +
    "1,0,3\n" +
    "2,2,6\n" +
    "3,4,8\n" +
    "4,6,9\n" +
    "5,8,9\n" +
    "6,10,8\n" +
    "7,12,6\n" +
    "8,14,3\n",
    {
      // options go here. See http://dygraphs.com/options.html
      legend: 'always',
      animatedZooms: true,
      title: 'dygraphs chart template'
    });
*/

  sensorChart = new VisChart2d(
    document.getElementById("sensor-chart-id"),
    "#chart-status-id",
    "Sensors",
    ['AccX', 'AccY', 'AccZ', 'MagX', 'MagY', 'MagZ'],
    -2, 2,
    ['GyroX', 'GyroY', 'GyroZ'],
    onChartEvent
  );

  attitudeChart = new VisChart2d(
    document.getElementById("error-chart-id"),
    null,
    "Attitude",
    ['Roll', 'Pitch', 'Yaw'],
    -180, 180,
    ['TorqX', 'TorqY', 'TorqZ'],
    onChartEvent
  );

  altitudeChart = new VisChart2d(
    document.getElementById("altitude-chart-id"),
    null,
    "Altitude",
    ['Altitude, m', 'Altitude Raw, m', 'Posture', 'Target Altitude, m'],
    -10, 40,
    ['Vertical Speed, m/s', 'Target Vertical Speed, m/s'],
    onChartEvent
  );

  rcValuesChart = new VisChart2d(
    document.getElementById("rcvalues-chart-id"),
    null,
    "RCValues",
    ['Yaw', 'Pitch', 'Roll', 'Throttle', 'Gear'],
    -1.25, 1.25,
    [],
    onChartEvent
  );

  function onChartEvent(event) {
    if (event.hasOwnProperty('start') && event.hasOwnProperty('end')) {
      if (syncGraphButton.isOn()) {
        sensorChart.setRange(event.start, event.end);
        attitudeChart.setRange(event.start, event.end);
        altitudeChart.setRange(event.start, event.end);
        rcValuesChart.setRange(event.start, event.end);
      }
    }
  }

  function onToggleChartAccXData(element) { sensorChart.enableDisableGroup('AccX', element.checked); }
  function onToggleChartAccYData(element) { sensorChart.enableDisableGroup('AccY', element.checked); }
  function onToggleChartAccZData(element) { sensorChart.enableDisableGroup('AccZ', element.checked); }
  function onToggleChartGyroXData(element) { sensorChart.enableDisableGroup('GyroX', element.checked); }
  function onToggleChartGyroYData(element) { sensorChart.enableDisableGroup('GyroY', element.checked); }
  function onToggleChartGyroZData(element) { sensorChart.enableDisableGroup('GyroZ', element.checked); }
  function onToggleChartMagXData(element) { sensorChart.enableDisableGroup('MagX', element.checked); }
  function onToggleChartMagYData(element) { sensorChart.enableDisableGroup('MagY', element.checked); }
  function onToggleChartMagZData(element) { sensorChart.enableDisableGroup('MagZ', element.checked); }

  /*
  function onToggleChartM1Data(element) { attitudeChart.enableDisableGroup('M1', element.checked); }
  function onToggleChartM2Data(element) { attitudeChart.enableDisableGroup('M2', element.checked); }
  function onToggleChartM3Data(element) { attitudeChart.enableDisableGroup('M3', element.checked); }
  function onToggleChartM4Data(element) { attitudeChart.enableDisableGroup('M4', element.checked); }
  */
  function onToggleChartAttitudeRollData(element) {
    attitudeChart.enableDisableGroup('Roll', element.checked);
  }
  function onToggleChartAttitudePitchData(element) {
    attitudeChart.enableDisableGroup('Pitch', element.checked);
  }
  function onToggleChartAttitudeYawData(element) {
    attitudeChart.enableDisableGroup('Yaw', element.checked);
  }

  function onToggleChartTorqXData(element) { attitudeChart.enableDisableGroup('TorqX', element.checked); }
  function onToggleChartTorqYData(element) { attitudeChart.enableDisableGroup('TorqY', element.checked); }
  function onToggleChartTorqZData(element) { attitudeChart.enableDisableGroup('TorqZ', element.checked); }


  function onToggleChartAltitude(element) { altitudeChart.enableDisableGroup('Altitude, m', element.checked); }
  function onToggleChartAltitudeRaw(element) { altitudeChart.enableDisableGroup('Altitude Raw, m', element.checked); }
  function onToggleChartTargetAltitude(element) { altitudeChart.enableDisableGroup('Target Altitude, m', element.checked); }
  function onToggleChartVerticalSpeed(element) { altitudeChart.enableDisableGroup('Vertical Speed, m/s', element.checked); }
  function onToggleChartTargetVerticalSpeed(element) { altitudeChart.enableDisableGroup('Target Vertical Speed, m/s', element.checked); }

  function quaternion2str(q) {
    return 'w:' + q.w.toFixed(3) + ' x:' + q.x.toFixed(3) + '  y:' + q.y.toFixed(3) + '  z:' + q.z.toFixed(3);
  }

  function vector2str(v) {
    return 'x:' + v[0].toFixed(3) + ' y:' + v[1].toFixed(3) + ' z:' + v[2].toFixed(3);
  }

  function onDisplayAlarm(droneState) {
    if (droneState.alarm != undefined) {
      $("#alarm").text(droneState.alarm);
      $("#alarm-time").text((droneState.alarm_time_ms/1000).toFixed(1));
      if (droneState.alarm_data != undefined) {
        $("#alarm-data").text(droneState.alarm_data);
        $("#alarm-data-row").css("display","block");
      } else {
        $("#alarm-data-row").css("display","none");
      }
      $("#alarm").css("color","red");
      $("#alarm-gr").css("display","block");
    } else {
      $("#alarm-gr").css("display","none");
    }
  }

  function onRestoreDefaultConfig() {
    restoreDefaultsView.onUserInput();
    restoreDefaultsView.onSubmitButton();
    rpcClient.rpcCall(droneRpcUrl, "sd_restore_config", "[]",
      function() { restoreDefaultsView.onDataSubmitOK(); },
      function() { restoreDefaultsView.onDataSubmitFail(); });
    return false;
  }

  function onSaveConfig2Flash() {
    save2FlashView.onUserInput();
    save2FlashView.onSubmitButton();
    rpcClient.rpcCall(droneRpcUrl, "sd_save_bootconfigdata_to_flash", "[]",
      function() { save2FlashView.onDataSubmitOK(); },
      function() { save2FlashView.onDataSubmitFail(); });
    return false;
  }

  function onPidXYCancel() {
    pidxyView.onCancelButton();
  }

  function onPidXYUserInput() {
    pidxyView.onUserInput();
  }

  function onPidXYSubmit() {
    var $myForm = $('#pidxy-form');

    if (!pidxyView.onSubmitButton()) {
      // return true so the form will be submitted
      // and automatic error will be displayed
      return true;
    }

    rpcClient.rpcCall(droneRpcUrl, "leakrate", "[" + $myForm[0].elements['leakrate-xy'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "kp", "[" + $myForm[0].elements['kp-xy'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "ki", "[" + $myForm[0].elements['ki-xy'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "kd", "[" + $myForm[0].elements['kd-xy'].value + "]",
      function() {pidxyView.onDataSubmitOK();},
      function() {pidxyView.onDataSubmitFail();});
    return false;
  }

  function onPidZCancel() {
    pidzView.onCancelButton();
  }

  function onPidZUserInput() {
    pidzView.onUserInput();
  }

  function onPidZSubmit() {
    var $myForm = $('#pidz-form');
    if (!pidzView.onSubmitButton()) {
      // return true so the form will be submitted
      // and automatic error will be displayed
      return true;
    }
    rpcClient.rpcCall(droneRpcUrl, "yaw_kp", "[" + $myForm[0].elements['kp-z'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "yaw_ki", "[" + $myForm[0].elements['ki-z'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "yaw_kd", "[" + $myForm[0].elements['kd-z'].value + "]",
      function() {pidzView.onDataSubmitOK();},
      function() {pidzView.onDataSubmitFail();});
    return false;
  }

  function onPidAltitudeCancel() { pidAltitudeView.onCancelButton(); }

  function onPidAltitudeUserInput() { pidAltitudeView.onUserInput();  }

  function onPidAltitudeSubmit() {
    var $myForm = $('#pid-altitude-form');
    if (!pidAltitudeView.onSubmitButton()) {
      // return true so the form will be submitted
      // and automatic error will be displayed
      return true;
    }
    rpcClient.rpcCall(droneRpcUrl, "sd_altitude_correction_period", "[" + $myForm[0].elements['alt-correction-period'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "sd_altitude_kp", "[" + $myForm[0].elements['kp-altitude'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "sd_altitude_ki", "[" + $myForm[0].elements['ki-altitude'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "sd_altitude_ki_leak", "[" + $myForm[0].elements['ki-altitude-leak'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "sd_altitude_kd", "[" + $myForm[0].elements['kd-altitude'].value + "]",
      function() {pidAltitudeView.onDataSubmitOK();},
      function() {pidAltitudeView.onDataSubmitFail();});
    return false;
  }

  function onPidGyroCancel() { pidGyroView.onCancelButton(); }

  function onPidGyroUserInput() { pidGyroView.onUserInput(); }

  function onPidGyroSubmit() {
    var $myForm = $('#pid-gyro-form');
    if (!pidGyroView.onSubmitButton()) {
      // return true so the form will be submitted
      // and automatic error will be displayed
      return true;
    }
    rpcClient.rpcCall(droneRpcUrl, "sd_gyro_drift_kp", "[" + $myForm[0].elements['kp-gyro'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "sd_gyro_drift_ki", "[" + $myForm[0].elements['ki-gyro'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "sd_gyro_drift_kd", "[" + $myForm[0].elements['kd-gyro'].value + "]",
      function() {pidGyroView.onDataSubmitOK();},
      function() {pidGyroView.onDataSubmitFail();});
    return false;
  }

  function onFlightCtlCancel() {
    flightCtlView.onCancelButton();
  }

  function onFlightCtlUserInput() {
    flightCtlView.onUserInput();
  }

  function onFlightCtlSubmit() {
    var $myForm = $('#flight-ctl-form');
    if (!flightCtlView.onSubmitButton()) {
      // return true so the form will be submitted
      // and automatic error will be displayed
      return true;
    }
    rpcClient.rpcCall(droneRpcUrl, "sd_set_yaw_throttle_factor",
      "[" + $myForm[0].elements['yaw-throttle-factor'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "sd_set_mag_tracking", "[" + $myForm[0].elements['track-magnetometer'].checked + "]");
    rpcClient.rpcCall(droneRpcUrl, "sd_enable_external_gyro", "[" + $myForm[0].elements['external-gyro'].checked + "]");
    rpcClient.rpcCall(droneRpcUrl, "roll_bias", "[" + $myForm[0].elements['torq-bias-roll'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "pitch_bias", "[" + $myForm[0].elements['torq-bias-pitch'].value + "]");
    if ($myForm[0].elements['flight-mode-id'].value == "flight-mode-position") {
      rpcClient.rpcCall(droneRpcUrl, "sd_flight_mode", "[" + "2" + "]");
    } else if ($myForm[0].elements['flight-mode-id'].value == "flight-mode-altitude") {
      rpcClient.rpcCall(droneRpcUrl, "sd_flight_mode", "[" + "1" + "]");
    } else {
      rpcClient.rpcCall(droneRpcUrl, "sd_flight_mode", "[" + "0" + "]");
    }
    rpcClient.rpcCall(droneRpcUrl, "yaw_bias", "[" + $myForm[0].elements['torq-bias-yaw'].value + "]",
      function() {flightCtlView.onDataSubmitOK();},
      function() {flightCtlView.onDataSubmitFail();});
    return false;
  }

  function onSensorsConfigCancel() {
    sensorCfgView.onCancelButton();
  }

  function onSensorsConfigUserInput() {
    sensorCfgView.onUserInput();
  }

  function onSensorsConfigSubmit() {
    var $myForm = $('#sensors-config-form');
    if (!sensorCfgView.onSubmitButton()) {
      // return true so the form will be submitted
      // and automatic error will be displayed
      return true;
    }
    rpcClient.rpcCall(droneRpcUrl, "sd_accelerometer_adjustment",
      "[[" + $myForm[0].elements['acc-bias-x'].value + "," +
      $myForm[0].elements['acc-bias-y'].value + "," +
      $myForm[0].elements['acc-bias-z'].value + "]]");
    rpcClient.rpcCall(droneRpcUrl, "sd_set_accelerometer_correction_period",
      "[" + $myForm[0].elements['acc-corr-period'].value + "]");
    rpcClient.rpcCall(droneRpcUrl, "sd_set_gyro_factor",
      "[" + $myForm[0].elements['gyro-factor'].value + "]",
      function() {sensorCfgView.onDataSubmitOK();},
      function() {sensorCfgView.onDataSubmitFail();});
    return false;
  }

  function toggleCollapsable(collapseId, buttonId, spanText) {
    $(collapseId).on("hide.bs.collapse", function(){
      $(buttonId).html('<span class="glyphicon glyphicon-triangle-right"></span> ' + spanText);
    });
    $(collapseId).on("show.bs.collapse", function(){
      $(buttonId).html('<span class="glyphicon glyphicon-triangle-bottom"></span> ' + spanText);
    });
  }

  function toggleStatusMessage(displayStatusMessage) {
    if (displayStatusMessage) {
      $("#warning-message-id").css("display","block");
    } else {
      $("#warning-message-id").css("display","none");
    }
  }

  function onRedrawBatteryIcon(batteryPercent, batteryVoltage) {
    var batIconClass = "fa-battery-0";
    if (batteryPercent > 15) { batIconClass = "fa-battery-1"; }
    if (batteryPercent > 25) { batIconClass = "fa-battery-2"; }
    if (batteryPercent > 50) { batIconClass = "fa-battery-3"; }
    if (batteryPercent > 75) { batIconClass = "fa-battery-4"; }
    $("#battery-icon").removeClass("fa-battery-0");
    $("#battery-icon").removeClass("fa-battery-1");
    $("#battery-icon").removeClass("fa-battery-2");
    $("#battery-icon").removeClass("fa-battery-3");
    $("#battery-icon").removeClass("fa-battery-4");
    $("#battery-icon").addClass(batIconClass);
    $("#battery-percent").text(batteryVoltage + "V " + batteryPercent);
  }

  function onRedrawMotorsArmedIcon(motorsArmed) {
    if (true == motorsArmed) {
      $("#motors-armed-icon").removeClass("fa-toggle-off");
      $("#motors-armed-icon").addClass("fa-toggle-on");
    } else {
      $("#motors-armed-icon").removeClass("fa-toggle-on");
      $("#motors-armed-icon").addClass("fa-toggle-off");
    }
  }

  function onRedrawMotorsAndBatteryStatus(droneState) {
    onRedrawBatteryIcon(
      droneState.battery_percentage.toFixed(0),
      droneState.battery_voltage.toFixed(2));

    onRedrawMotorsArmedIcon(droneState.motors_armed);

    toggleStatusMessage(false);
  }

  function updateSensorChart(sensorDataStream) {
    for (var i = 0; i < sensorDataStream.length; ++i) {
      var samples = sensorDataStream[i].accel;
      samples = samples.concat(sensorDataStream[i].mag);
      samples = samples.concat(sensorDataStream[i].gyro);
      sensorChart.update(samples, sensorDataStream[i].serial);
    }
  }

  function updateVectorErrorChart(sensorDataStream) {
    for (var i = 0; i < sensorDataStream.length; ++i) {
      var samples = qt2EulerDeg(sensorDataStream[i].attitude);
      samples = samples.concat(sensorDataStream[i].pid_torque);
      attitudeChart.update(samples, sensorDataStream[i].serial);
    }
  }

  function updateAltitudeChart(dataStream) {
    for (var i = 0; i < dataStream.length; ++i) {
      altitudeChartModel.update(dataStream[i]);
      var posture = 0.0;
      if (dataStream[i].flight_posture == "Descend") {
        posture = 0.25;
      } else if (dataStream[i].flight_posture == "Altitude Hold") {
        posture = 0.5;
      } else if (dataStream[i].flight_posture == "Ascend") {
        posture = 0.75;
      }
      var samples = [
        altitudeChartModel.relativeAltitude(),
        altitudeChartModel.relativeRawAltitude(),
        posture,
        altitudeChartModel.relativeTargetAltitude(),
        altitudeChartModel.verticalSpeed, //altitudeChartModel.verticalSpeedGps
        dataStream[i].target_vert_speed
      ];
      altitudeChart.update(samples, dataStream[i].serial);
    }
  }

  function updateRcValuesChart(dataStream) {
    for (var i = 0; i < dataStream.length; ++i) {
      var samples = [
        dataStream[i].yaw,
        dataStream[i].pitch,
        dataStream[i].roll,
        dataStream[i].base_throttle,
        dataStream[i].gear
        ];
      rcValuesChart.update(samples, dataStream[i].serial);
    }
  }

  function getDataStreamCallback(response) {
    if (response.error != null) {
      console.log(JSON.stringify(response.result));
    } else {
      updateSensorChart(response.result);
      updateVectorErrorChart(response.result);
    }
  }

  function updateDroneState(response) {
    if (response.error != null) {
      console.log(JSON.stringify(response.result));
    } else {

      droneState = response.result;

      //
      // For display purposes convert the attitude quaternion to the
      // world coordinate system.
      //
      droneState.attitude = qtConjugate(droneState.attitude);

      droneState.zVector = qtRotateVector(droneState.attitude, [0,0,1]);
      droneState.zVectorTarget = qtRotateVector(droneState.target, [0,0,1]);

      if (collectDataButton.isOn()) {
        droneState.serial = droneState.iteration;
        updateSensorChart([droneState]);
        updateVectorErrorChart([droneState]);
        updateAltitudeChart([droneState]);
        updateRcValuesChart([droneState]);
      }

      //console.log("Iteration: ", droneState.iteration);
      //console.log("Pressure, hpa: ", droneState.pressure_hpa)

      onRedrawMotorsAndBatteryStatus(droneState);

      onDisplayAlarm(droneState);

      $("#attQ").text(quaternion2str(response.result.attitude));
      //$("#euler-angles-id").text(vector2str(qt2EulerDeg(response.result.attitude)) + " [deg]");
      var deg = qt2EulerDeg(response.result.attitude);
      $("#euler-angles-id").text("Roll: " + deg[0].toFixed(3) + " Pitch: " + deg[1].toFixed(3) + " Yaw: " + deg[2].toFixed(3) + " deg");

      $("#accel").text(vector2str(response.result.accel));
      $("#gyro").text(vector2str(response.result.gyro));
      $("#gyro-raw-id").text(vector2str(response.result.gyro_raw));
      $("#gyro-drift-id").text(vector2str(response.result.gyro_drift));
      $("#mag").text(vector2str(response.result.mag));
      $("#altitude").text(response.result.altitude_meters.toFixed(2));
      $("#flight-posture-id").text(response.result.flight_posture);
      $("#hpa").text(response.result.pressure_hpa);
      $("#temperature").text(response.result.temperature);

      if (response.result.motors_armed) {
        m1.refresh(response.result.motors[2] * 100);
        m2.refresh(response.result.motors[3] * 100);
        m3.refresh(response.result.motors[0] * 100);
        m4.refresh(response.result.motors[1] * 100);
      } else {
        m1.refresh(0); m2.refresh(0);
        m3.refresh(0); m4.refresh(0);
      }

      $("#temperature_val").text(response.result.temperature.toFixed(1) + ' ');
      if (response.result.gps_satellites >= 3) {
        $("#gps-lat").text((response.result.gps_latitude/1000000).toFixed(6));
        $("#gps-long").text((response.result.gps_longitude/1000000).toFixed(6));
        $("#gps-speed").text(response.result.gps_speed_kmph.toFixed(1));
        $("#gps-course").text(response.result.gps_course_deg.toFixed(2));
      } else {
        $("#gps-lat").text("N/A");
        $("#gps-long").text("N/A");
      }
      $("#gps-satellites").text(response.result.gps_satellites);
      if (response.result.gps_satellites >= 4) {
        $("#gps-altitude").text(response.result.gps_altitude.toFixed(2));
      } else {
        $("#gps-speed").text('0');
        $("#gps-course").text( 'N/A');
        $("#gps-altitude").text('N/A');
      }
      $("#gps-position-error").text(response.result.position_error.toFixed(2));
      $("#dt").text(response.result.dt/1000);

      $("#roll-id").text(droneState.roll.toFixed(4));
      $("#pitch-id").text(droneState.pitch.toFixed(4));
      $("#yaw-id").text(droneState.yaw.toFixed(4));
      $("#throttle-id").text(droneState.base_throttle.toFixed(4));

      /*
       * Update the forms
       */
       pidxyView.onRedrawData(response.result);
       pidzView.onRedrawData(response.result);
       pidAltitudeView.onRedrawData(response.result);
       pidGyroView.onRedrawData(response.result);
       flightCtlView.onRedrawData(response.result);
       sensorCfgView.onRedrawData(response.result);
       restoreDefaultsView.onRedrawData(response.result);
       save2FlashView.onRedrawData(response.result);
       onRedrawSensorCalibrationData(response.result);
    }
  }

  $(document).ready(function() {
    toggleCollapsable("#sensors-id", "#sensors-btn", "Sensors");
    toggleCollapsable("#motors-id", "#motors-btn", "Motors");
    toggleCollapsable("#gps-id", "#gps-btn", "GPS");
    toggleCollapsable("#rc-control-id", "#rc-control-btn", "RC Control");
    toggleCollapsable("#pidxy-id", "#pidxy-btn", "PID Controller XY");
    toggleCollapsable("#pidz-id", "#pidz-btn", "PID Controller Z");
    toggleCollapsable("#pid-gyro-id", "#pid-gyro-btn", "PID Controller Gyro Drift");
    toggleCollapsable("#pid-altitude-id", "#pid-altitude-btn", "Altitude Controller");
    toggleCollapsable("#sensors-config-id", "#sensors-config-btn", "Configure Sensors");
    toggleCollapsable("#flight-ctl-id", "#flight-ctl-btn", "Flight Control");
    toggleCollapsable("#sensors-calibrate-id", "#sensors-calibrate-btn", "Calibrate Sensors");
    toggleCollapsable("#sensor-chart-ydata-select-id", "#sensor-chart-data-select-bt", "Filter Data");
    toggleCollapsable("#error-chart-ydata-select-id", "#error-chart-data-select-bt", "Filter Data");
    toggleCollapsable("#altitude-chart-ydata-select-id", "#altitude-chart-data-select-bt", "Filter Data");
    toggleStatusMessage(true);

    m1 = new JustGage({
          id: "motor1",
          value: 0,
          min: 0,
          max: 100,
          title: "M1",
          label: "%"
        });
    m2 = new JustGage({
          id: "motor2",
          value: 0,
          min: 0,
          max: 100,
          title: "M2",
          label: "%"
        });
    m3 = new JustGage({
          id: "motor3",
          value: 0,
          min: 0,
          max: 100,
          title: "M3",
          label: "%"
        });
    m4 = new JustGage({
          id: "motor4",
          value: 0,
          min: 0,
          max: 100,
          title: "M4",
          label: "%"
        });
    m1.refresh(0);
    m2.refresh(0);
    m3.refresh(0);
    m4.refresh(0);
  });

  function onSigmaDroneLogoClick() {
    $("#home-button").click();
  }

  function getDroneRpcUrl() {
    var url = window.location.href;
    if (url == null || url.match("file*")) {
      return "http://10.10.10.1:18222/firmware";
    }
    if (url[url.length-1] == '/') {
      url = url.substring(0, url.length-1);
    }
    return url + ":18222/firmware";
  }

  $.ajaxSetup({ timeout: 5000 });

  var redrawGraph = false;
  function onToggleCollectDataButton() {
    collectDataButton.onToggle();
    if (collectDataButton.isOff()) {
      // Disable the button while drawing the chart
      $("#collect-data-btn").addClass("disabled");
      sensorChart.updateStatus("DRAWING");
      attitudeChart.updateStatus("DRAWING");
      altitudeChart.updateStatus("DRAWING");
      rcValuesChart.updateStatus("DRAWING");
      redrawGraph = true;
    } else {
      sensorChart.reset();
      attitudeChart.reset();
      altitudeChart.reset();
      rcValuesChart.reset();
      altitudeChartModel = new AltitudeViewModel(droneState);
    }
  }

  function onToggleSyncGraphButton() {
    syncGraphButton.onToggle();
    if (syncGraphButton.isOn()) {
      onChartEvent(sensorChart.getRange());
    }
  }

  function onRedrawSensorCalibrationData(droneState) {
    $("#mag-bias-id").text(vector2str(droneState.mag_bias));
    $("#mag-scale-id").text(vector2str(droneState.mag_scale_factor));
  }

  function onToggleMagCalibrateButton() {
    magCalibrateButton.onToggle();

    if (magCalibrateButton.isOn()) {
      rpcClient.rpcCall(droneRpcUrl,"sd_calibrate_mag","[true]",
        function() {
          $("#mag-calib-data-id").css("display","none");
          $("#mag-calibrate-message-id").text(
          "Perform 360 degree rotation of the platform along all 3 axes; when done toggle the button.");
        }
      );
    } else {
      rpcClient.rpcCall(droneRpcUrl,"sd_calibrate_mag","[false]");
        $("#mag-calibrate-message-id").text("");
        $("#mag-calib-data-id").css("display","block");
    }
  }

  function timerCount() {
    return timerCount.i++;
  }

  timerCount.i = 0;
  window.setInterval(
    function () {
      if (redrawGraph) {
        redrawGraph = false;
        sensorChart.draw();
        attitudeChart.draw();
        altitudeChart.draw();
        rcValuesChart.draw();
        $("#collect-data-btn").removeClass("disabled");
      }
      if (rpcClient.failureCount() > 5) {
        toggleStatusMessage(true);
      }
      if (!rpcClient.isBusy()) {
        rpcClient.rpcCall(
          droneRpcUrl = getDroneRpcUrl(),
          "sd_get_dronestate_ex",
          JSON.parse("[]"),
          updateDroneState
        );
        /*
        if (collectDataButton.isOff()) { //} 0 == (timerCount() % 2)) {
          rpcClient.rpcCall(
            droneRpcUrl = getDroneRpcUrl(),
            "sd_get_dronestate_ex",
            JSON.parse("[]"),
            updateDroneState
          );
        } else if (collectDataButton.isOn()) {
          rpcClient.rpcCall(
            droneRpcUrl = getDroneRpcUrl(),
            "sd_get_datastream",
            JSON.parse("[]"),
            getDataStreamCallback
          );
        }
        */
      }
    },
    50);

  </script>

  </body>
  </html>
